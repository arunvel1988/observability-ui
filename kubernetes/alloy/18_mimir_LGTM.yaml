apiVersion: apps/v1
kind: Deployment
metadata:
  name: mimir
  namespace: logging
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mimir
  template:
    metadata:
      labels:
        app: mimir
    spec:
      containers:
        - name: mimir
          image: grafana/mimir:2.15.0
          args:
            - "-config.file=/etc/mimir/config.yaml"
            - "-target=all"
          ports:
            - containerPort: 9009
              name: http
            - containerPort: 9095
              name: grpc
          volumeMounts:
            - name: mimir-config
              mountPath: /etc/mimir
            - name: mimir-data
              mountPath: /tmp/mimir
      volumes:
        - name: mimir-config
          configMap:
            name: mimir-config
        - name: mimir-data
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: mimir
  namespace: logging
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 9009
      targetPort: 9009
      protocol: TCP
    - name: grpc
      port: 9095
      targetPort: 9095
      protocol: TCP
  selector:
    app: mimir
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mimir-config
  namespace: logging
data:
  config.yaml: |
    multitenancy_enabled: false
    
    server:
      http_listen_port: 9009
      grpc_listen_port: 9095
      log_level: info
    
    common:
      storage:
        backend: filesystem
        filesystem:
          dir: /tmp/mimir/data
    
    blocks_storage:
      backend: filesystem
      filesystem:
        dir: /tmp/mimir/blocks
      tsdb:
        dir: /tmp/mimir/tsdb
      bucket_store:
        sync_dir: /tmp/mimir/tsdb-sync
    
    compactor:
      data_dir: /tmp/mimir/compactor
      compaction_interval: 30m
      deletion_delay: 2h
      symbols_flushers_concurrency: 4
      first_level_compaction_wait_period: 25m
    
    distributor:
      ring:
        kvstore:
          store: inmemory
    
    ingester:
      ring:
        kvstore:
          store: inmemory
        replication_factor: 1
    
    ruler_storage:
      backend: filesystem
      filesystem:
        dir: /tmp/mimir/rules
    
    ruler:
      rule_path: /tmp/mimir/rules-temp
      alertmanager_url: http://localhost:9093
      ring:
        kvstore:
          store: inmemory
    
    store_gateway:
      sharding_ring:
        replication_factor: 1
        kvstore:
          store: inmemory
    
    limits:
      ingestion_rate: 50000
      ingestion_burst_size: 100000
      max_global_series_per_user: 1000000
      max_global_exemplars_per_user: 100000
      native_histograms_ingestion_enabled: true
    
    usage_stats:
      enabled: false
